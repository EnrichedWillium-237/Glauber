
TH1D * hpsiC[7][ncentbins];

TGraphErrors * gC[7];
TGraphErrors * gC_2_1;
TGraphErrors * gC_3_1;
TGraphErrors * gC_3_2;
TGraphErrors * gC_4_2;

TGraphErrors * cgC_4_p4_p2;
TGraphErrors * cgC_8_p4_p2;
TGraphErrors * cgC_12_p4_p2;
TGraphErrors * cgC_6_p3_p2;
TGraphErrors * cgC_6_p2_p6;
TGraphErrors * cgC_6_p3_p6;
TGraphErrors * cgC_12_p3_p4;
TGraphErrors * cgC_10_p2_p5;

TGraphErrors * cgC_2p2_3p3_5p5;
TGraphErrors * cgC_2p2_4p4_6p6;
TGraphErrors * cgC_2p2_6p3_4p4;
TGraphErrors * cgC_8p2_3p3_5p5;
TGraphErrors * cgC_10p2_4p4_6p6;
TGraphErrors * cgC_10p2_6p3_4p4;

TGraphErrors * cgC_6p2_p3;
TGraphErrors * cgC_4p2_p4;
TGraphErrors * cgC_6p2_p6;
TGraphErrors * cgC_6p3_p6;
TGraphErrors * cgC_10p2_p5;
TGraphErrors * cgC_15p3_p5;

TGraphErrors * cgC_2p1_p2;
TGraphErrors * cgC_3p1_p3;
TGraphErrors * cgC_4p1_p4;
TGraphErrors * cgC_5p1_p5;
TGraphErrors * cgC_6p1_p6;

TGraphErrors * cgC_1p1_2p2_3p3;
TGraphErrors * cgC_4p1_2p2_6p3;
TGraphErrors * cgC_2p1_4p2_6p3;
TGraphErrors * cgC_5p1_2p2_3p3;
TGraphErrors * cgC_2p1_2p2_4p4;
TGraphErrors * cgC_2p1_6p2_4p4;
TGraphErrors * cgC_2p1_6p2_8p4;

TGraphErrors * cgC_1p1_3p3_4p4;
TGraphErrors * cgC_2p1_6p3_4p4;
TGraphErrors * cgC_1p1_4p2_5p5;
TGraphErrors * cgC_3p1_2p2_5p5;
TGraphErrors * cgC_1p1_6p3_5p5;
TGraphErrors * cgC_2p1_3p3_5p5;
TGraphErrors * cgC_4p1_9p3_5p5;

TH2D * xyC0[ncentbins];
TH2D * xyC1[ncentbins];
TH2D * xyC2[ncentbins];
TH2D * xyC3[ncentbins];
TH2D * xyC4[ncentbins];
TH2D * xyC5[ncentbins];
TH2D * xyC6[ncentbins];

TH2D * Psi2Psi1C[ncentbins];
TH2D * Psi3Psi1C[ncentbins];
TH2D * Psi3Psi2C[ncentbins];
TH2D * Psi4Psi2C[ncentbins];

TH1D * CosPsi2Psi1C[ncentbins];
TH1D * CosPsi3Psi1C[ncentbins];
TH1D * CosPsi3Psi2C[ncentbins];
TH1D * CosPsi4Psi2C[ncentbins];

TH2D * Psi2Psi1DiffC[ncentbins];
TH2D * Psi3Psi1DiffC[ncentbins];
TH2D * Psi5Psi1DiffC[ncentbins];
TH2D * Psi3Psi2DiffC[ncentbins];
TH2D * Psi4Psi2DiffC[ncentbins];

TH1D * eccAngC[7][ncentbins];
TH1D * eccDistC[7][ncentbins];

double eccC[7][ncentbins];
double eccCCnt[7][ncentbins];
double eccC_pow2[7][ncentbins];
double eccC_err[7][ncentbins];

double eccC_2_1[ncentbins];
double eccC_3_1[ncentbins];
double eccC_3_2[ncentbins];
double eccC_4_2[ncentbins];
double eccC_2_1_pow2[ncentbins];
double eccC_3_1_pow2[ncentbins];
double eccC_3_2_pow2[ncentbins];
double eccC_4_2_pow2[ncentbins];
double eccC_2_1_err[ncentbins];
double eccC_3_1_err[ncentbins];
double eccC_3_2_err[ncentbins];
double eccC_4_2_err[ncentbins];

double eccC_2_1_cnt[ncentbins];
double eccC_3_1_cnt[ncentbins];
double eccC_3_2_cnt[ncentbins];
double eccC_4_2_cnt[ncentbins];

double cC_4_p4_p2[ncentbins];
double cC_8_p4_p2[ncentbins];
double cC_12_p4_p2[ncentbins];
double cC_6_p3_p2[ncentbins];
double cC_6_p2_p6[ncentbins];
double cC_6_p3_p6[ncentbins];
double cC_12_p3_p4[ncentbins];
double cC_10_p2_p5[ncentbins];
double cC_2p2_3p3_5p5[ncentbins];
double cC_2p2_4p4_6p6[ncentbins];
double cC_2p2_6p3_4p4[ncentbins];
double cC_8p2_3p3_5p5[ncentbins];
double cC_10p2_4p4_6p6[ncentbins];
double cC_10p2_6p3_4p4[ncentbins];
double cC_4_p4_p2_pow2[ncentbins];
double cC_8_p4_p2_pow2[ncentbins];
double cC_12_p4_p2_pow2[ncentbins];
double cC_6_p3_p2_pow2[ncentbins];
double cC_6_p2_p6_pow2[ncentbins];
double cC_6_p3_p6_pow2[ncentbins];
double cC_12_p3_p4_pow2[ncentbins];
double cC_10_p2_p5_pow2[ncentbins];
double cC_2p2_3p3_5p5_pow2[ncentbins];
double cC_2p2_4p4_6p6_pow2[ncentbins];
double cC_2p2_6p3_4p4_pow2[ncentbins];
double cC_8p2_3p3_5p5_pow2[ncentbins];
double cC_10p2_4p4_6p6_pow2[ncentbins];
double cC_10p2_6p3_4p4_pow2[ncentbins];
double cC_4_p4_p2_err[ncentbins];
double cC_8_p4_p2_err[ncentbins];
double cC_12_p4_p2_err[ncentbins];
double cC_6_p3_p2_err[ncentbins];
double cC_6_p2_p6_err[ncentbins];
double cC_6_p3_p6_err[ncentbins];
double cC_12_p3_p4_err[ncentbins];
double cC_10_p2_p5_err[ncentbins];
double cC_2p2_3p3_5p5_err[ncentbins];
double cC_2p2_4p4_6p6_err[ncentbins];
double cC_2p2_6p3_4p4_err[ncentbins];
double cC_8p2_3p3_5p5_err[ncentbins];
double cC_10p2_4p4_6p6_err[ncentbins];
double cC_10p2_6p3_4p4_err[ncentbins];

double cC_6p2_p3[ncentbins];
double cC_4p2_p4[ncentbins];
double cC_6p2_p6[ncentbins];
double cC_6p3_p6[ncentbins];
double cC_10p2_p5[ncentbins];
double cC_15p3_p5[ncentbins];
double cC_2p1_p2[ncentbins];
double cC_3p1_p3[ncentbins];
double cC_4p1_p4[ncentbins];
double cC_5p1_p5[ncentbins];
double cC_6p1_p6[ncentbins];
double cC_1p1_2p2_3p3[ncentbins];
double cC_4p1_2p2_6p3[ncentbins];
double cC_2p1_4p2_6p3[ncentbins];
double cC_5p1_2p2_3p3[ncentbins];
double cC_2p1_2p2_4p4[ncentbins];
double cC_2p1_6p2_4p4[ncentbins];
double cC_2p1_6p2_8p4[ncentbins];
double cC_1p1_3p3_4p4[ncentbins];
double cC_2p1_6p3_4p4[ncentbins];
double cC_2p1_4p2_5p5[ncentbins];
double cC_3p1_2p2_5p5[ncentbins];
double cC_1p1_6p3_5p5[ncentbins];
double cC_2p1_3p3_5p5[ncentbins];
double cC_4p1_9p3_5p5[ncentbins];
double cC_6p2_p3_pow2[ncentbins];
double cC_4p2_p4_pow2[ncentbins];
double cC_6p2_p6_pow2[ncentbins];
double cC_6p3_p6_pow2[ncentbins];
double cC_10p2_p5_pow2[ncentbins];
double cC_15p3_p5_pow2[ncentbins];
double cC_2p1_p2_pow2[ncentbins];
double cC_3p1_p3_pow2[ncentbins];
double cC_4p1_p4_pow2[ncentbins];
double cC_5p1_p5_pow2[ncentbins];
double cC_6p1_p6_pow2[ncentbins];
double cC_1p1_2p2_3p3_pow2[ncentbins];
double cC_4p1_2p2_6p3_pow2[ncentbins];
double cC_2p1_4p2_6p3_pow2[ncentbins];
double cC_5p1_2p2_3p3_pow2[ncentbins];
double cC_2p1_2p2_4p4_pow2[ncentbins];
double cC_2p1_6p2_4p4_pow2[ncentbins];
double cC_2p1_6p2_8p4_pow2[ncentbins];
double cC_1p1_3p3_4p4_pow2[ncentbins];
double cC_2p1_6p3_4p4_pow2[ncentbins];
double cC_2p1_4p2_5p5_pow2[ncentbins];
double cC_3p1_2p2_5p5_pow2[ncentbins];
double cC_1p1_6p3_5p5_pow2[ncentbins];
double cC_2p1_3p3_5p5_pow2[ncentbins];
double cC_4p1_9p3_5p5_pow2[ncentbins];
double cC_6p2_p3_err[ncentbins];
double cC_4p2_p4_err[ncentbins];
double cC_6p2_p6_err[ncentbins];
double cC_6p3_p6_err[ncentbins];
double cC_10p2_p5_err[ncentbins];
double cC_15p3_p5_err[ncentbins];
double cC_2p1_p2_err[ncentbins];
double cC_3p1_p3_err[ncentbins];
double cC_4p1_p4_err[ncentbins];
double cC_5p1_p5_err[ncentbins];
double cC_6p1_p6_err[ncentbins];
double cC_1p1_2p2_3p3_err[ncentbins];
double cC_4p1_2p2_6p3_err[ncentbins];
double cC_2p1_4p2_6p3_err[ncentbins];
double cC_5p1_2p2_3p3_err[ncentbins];
double cC_2p1_2p2_4p4_err[ncentbins];
double cC_2p1_6p2_4p4_err[ncentbins];
double cC_2p1_6p2_8p4_err[ncentbins];
double cC_1p1_3p3_4p4_err[ncentbins];
double cC_2p1_6p3_4p4_err[ncentbins];
double cC_2p1_4p2_5p5_err[ncentbins];
double cC_3p1_2p2_5p5_err[ncentbins];
double cC_1p1_6p3_5p5_err[ncentbins];
double cC_2p1_3p3_5p5_err[ncentbins];
double cC_4p1_9p3_5p5_err[ncentbins];

double cC_cnt[ncentbins];


double PsiNCumu(double order, int npart, double * x, double * y, double &eccangC) {
    double sx[7];
    double sy[7];
    double rs[7];
    double rn[7];
    double sxC = 0;
    double syC = 0;
    for (int iorder = 1; iorder<=6; iorder++) {
        sx[iorder] = 0;
        sy[iorder] = 0;
        rs[iorder] = iorder;
    }
    rs[1] = 3;
    for (int iorder = 1; iorder<=6; iorder++) {
        for (int i = 0; i<npart; i++) {
            double r = sqrt( x[i]*x[i] + y[i]*y[i]);
            double ang = TMath::ATan2(y[i],x[i]);
            // rn[iorder] = pow(r,rs[iorder]);
            rn[iorder] = pow(r,2); // for r^2 weighting
            sx[iorder] += rn[iorder]*TMath::Cos(iorder*ang);
            sy[iorder] += rn[iorder]*TMath::Sin(iorder*ang);
        }
        if (sx[iorder] == 0 && sy[iorder] == 0) return -10;
        sx[iorder]/=(double)npart;
        sy[iorder]/=(double)npart;
    }

    if (order == 1) {
        sxC = sx[1];
        syC = sy[1];
    }
    if (order == 2) {
        sxC = sx[2];
        syC = sy[2];
    }
    if (order == 3) {
        sxC = sx[3];
        syC = sy[3];
    }
    if (order == 4) {
        sxC = sx[4] - 3*pow(sx[2],2);
        syC = sy[4] - 3*pow(sy[2],2);
    }
    if (order == 5) {
        sxC = sx[5] - 10*sx[2]*sx[3];
        syC = sy[5] - 10*sy[2]*sy[3];
    }
    if (order == 6) {
        sxC = sx[6] - 15*sx[4]*sx[2] - 10*pow(sx[3],2) + 30*pow(sx[2],3);
        syC = sy[6] - 15*sy[4]*sy[2] - 10*pow(sy[3],2) + 30*pow(sy[2],3);
    }

    double angEP;
    eccangC = bounds(order,(1/order)*TMath::ATan2(syC,sxC));
    angEP = bounds(order,(1/order)*(TMath::ATan2(syC,sxC) - TMath::Pi()));
    return angEP;
}

double cumulantEcc(double order, int npart, double * x, double * y, double psi1, double psi2, double psi3, double psi4, double psi5, double psi6) {
    double psi[7];
    double avz[7];
    double avr[7];
    double rs[7];
    double rn[7];
    double avzC = 0;
    for (int iorder = 1; iorder<=6; iorder++) {
        avz[iorder] = 0;
        avr[iorder] = 0;
        rs[iorder] = iorder;
    }
    psi[1] = psi1;
    psi[2] = psi2;
    psi[3] = psi3;
    psi[4] = psi4;
    psi[5] = psi5;
    psi[6] = psi6;
    rs[1] = 3;

    for (int iorder = 1; iorder<=6; iorder++) {
        for (int i = 0; i<npart; i++) {
            double r = sqrt( x[i]*x[i] + y[i]*y[i] );
            double ang = TMath::ATan2(y[i],x[i]);
            // rn[iorder] = pow(r, rs[iorder]);
            rn[iorder] = pow(r, 2); // for r^2 weighting
            double zx = rn[iorder]*TMath::Cos(ang-psi[iorder]);
            double zy = rn[iorder]*TMath::Sin(ang-psi[iorder]);
            if (iorder == 1) {
                avz[iorder] += pow(zx,3) + zx*zy*zy;
            }
            if (iorder == 2) {
                avz[iorder] += zx*zx - zy*zy;
            }
            if (iorder == 3) {
                avz[iorder] += pow(zx,3) - 3*zx*zy*zy;
            }
            if (iorder == 4) {
                avz[iorder] += pow(zx,4) - 6*zx*zx*zy*zy + pow(zy,4);
            }
            if (iorder == 5) {
                avz[iorder] += pow(zx,5) - 10*pow(zx,3)*zy*zy + 5*zx*pow(zy,4);
            }
            if (iorder == 6) {
                avz[iorder] += pow(zx,6) - 15*pow(zx,4)*zy*zy + 15*zx*zx*pow(zy,4) - pow(zy,6);
            }
            avr[iorder] += rn[iorder];
        }
        avz[iorder]/=(double)npart;
        avr[iorder]/=(double)npart;
    }

    if (order == 1) {
        avzC = avz[1];
    }
    if (order == 2) {
        avzC = avz[2];
    }
    if (order == 3) {
        avzC = avz[3];
    }
    if (order == 4) {
        avzC = avz[4] - 3*pow(avz[2],2);
    }
    if (order == 5) {
        avzC = avz[5] - 10*avz[2]*avz[3];
    }
    if (order == 6) {
        avzC = avz[6] - 15*avz[4]*avz[2] - 10*pow(avz[3],2) + 30*pow(avz[2],3);
    }

    return -1.*avzC/avr[(int)order];
}

void SetupCumulant(int cbin, int lcmin, int lcmax) {
    xyC0[cbin] = (TH2D *) xy0[cbin]->Clone(Form("xyC0_%d-%d",lcmin,lcmax));
    xyC1[cbin] = (TH2D *) xy0[cbin]->Clone(Form("xyC1_%d-%d",lcmin,lcmax));
    xyC2[cbin] = (TH2D *) xy0[cbin]->Clone(Form("xyC2_%d-%d",lcmin,lcmax));
    xyC3[cbin] = (TH2D *) xy0[cbin]->Clone(Form("xyC3_%d-%d",lcmin,lcmax));
    xyC4[cbin] = (TH2D *) xy0[cbin]->Clone(Form("xyC4_%d-%d",lcmin,lcmax));
    xyC5[cbin] = (TH2D *) xy0[cbin]->Clone(Form("xyC5_%d-%d",lcmin,lcmax));
    xyC6[cbin] = (TH2D *) xy0[cbin]->Clone(Form("xyC6_%d-%d",lcmin,lcmax));

    Psi2Psi1C[cbin] = (TH2D *) Psi2Psi1[cbin]->Clone("Psi2Psi1C");
    Psi3Psi1C[cbin] = (TH2D *) Psi3Psi1[cbin]->Clone("Psi3Psi1C");
    Psi3Psi2C[cbin] = (TH2D *) Psi3Psi2[cbin]->Clone("Psi3Psi2C");
    Psi4Psi2C[cbin] = (TH2D *) Psi4Psi2[cbin]->Clone("Psi4Psi2C");

    CosPsi2Psi1C[cbin] = (TH1D *) CosPsi2Psi1[cbin]->Clone("CosPsi2Psi1C");
    CosPsi3Psi1C[cbin] = (TH1D *) CosPsi3Psi1[cbin]->Clone("CosPsi3Psi1C");
    CosPsi3Psi2C[cbin] = (TH1D *) CosPsi3Psi2[cbin]->Clone("CosPsi3Psi2C");
    CosPsi4Psi2C[cbin] = (TH1D *) CosPsi4Psi2[cbin]->Clone("CosPsi4Psi2C");

    Psi2Psi1DiffC[cbin] = (TH2D *) Psi2Psi1Diff[cbin]->Clone("Psi2Psi1DiffC");
    Psi3Psi1DiffC[cbin] = (TH2D *) Psi3Psi1Diff[cbin]->Clone("Psi3Psi1DiffC");
    Psi5Psi1DiffC[cbin] = (TH2D *) Psi5Psi1Diff[cbin]->Clone("Psi5Psi1DiffC");
    Psi3Psi2DiffC[cbin] = (TH2D *) Psi3Psi2Diff[cbin]->Clone("Psi3Psi2DiffC");
    Psi4Psi2DiffC[cbin] = (TH2D *) Psi4Psi2Diff[cbin]->Clone("Psi4Psi2DiffC");

    for (int iorder = 0; iorder<=6; iorder++) {
        eccAngC[iorder][cbin] = (TH1D *) eccAng[iorder][cbin]->Clone(Form("eccAngC%d_%d-%d",iorder,lcmin,lcmax));
        eccDistC[iorder][cbin] = (TH1D *) eccDist[iorder][cbin]->Clone(Form("eccDistC%d_%d-%d",iorder,lcmin,lcmax));
    }
}
